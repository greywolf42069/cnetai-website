<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNetAI Dashboard</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/icons/favicon.ico" type="image/x-icon">
    <link rel="icon" href="assets/logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/logo.svg">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="assets/logo.svg" alt="CNetAI Logo">
            </div>
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="index.html#vision">Vision</a></li>
                    <li><a href="index.html#features">Features</a></li>
                    <li><a href="index.html#tokenomics">Tokenomics</a></li>
                    <li><a href="index.html#roadmap">Roadmap</a></li>
                    <li><a href="index.html#developers">Developers</a></li>
                    <li><a href="index.html#about">About</a></li>
                </ul>
                <button class="connect-wallet-btn" id="connectWallet">Connect Wallet</button>
            </nav>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <section class="dashboard">
        <div class="container">
            <h1 class="section-title">Wallet Dashboard</h1>
            
            <div class="dashboard-content">
                <div class="wallet-info-card">
                    <h2>Wallet Information</h2>
                    <div class="wallet-details">
                        <div class="detail-item">
                            <span class="label">Address:</span>
                            <span class="value wallet-address" id="walletAddress">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Balance:</span>
                            <span class="value" id="tokenBalance">0 ASC</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Battle Chips:</span>
                            <span class="value" id="battleChips">0</span>
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn secondary-btn" id="disconnectWallet">Disconnect</button>
                        <button class="btn primary-btn" id="sendTokens">Send Tokens</button>
                    </div>
                </div>
                
                <div class="activity-card">
                    <h2>Recent Activity</h2>
                    <div class="activity-list" id="activityList">
                        <div class="activity-item">
                            <div class="activity-icon">ðŸ”’</div>
                            <div class="activity-details">
                                <div class="activity-title">Wallet Connected</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">ðŸª™</div>
                            <div class="activity-details">
                                <div class="activity-title">Wallet Created</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h2>Network Stats</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">1,247</div>
                            <div class="stat-label">Active Miners</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">89.2K</div>
                            <div class="stat-label">Threats Blocked</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">42.7M</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">99.9%</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="assets/logo.svg" alt="CNetAI Logo">
                    <p>SECURE. INTELLIGENT. DECENTRALIZED.</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Product</h3>
                        <ul>
                            <li><a href="#">NetAI dApp</a></li>
                            <li><a href="#">Whitepaper</a></li>
                            <li><a href="#">Documentation</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Community</h3>
                        <ul>
                            <li><a href="#">Discord</a></li>
                            <li><a href="#">Twitter</a></li>
                            <li><a href="#">Telegram</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Resources</h3>
                        <ul>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">GitHub</a></li>
                            <li><a href="#">Explorer</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 CNetAI. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <!-- Wallet Creation/Import Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="walletSetupContainer">
                <!-- Wallet setup steps will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Import the WASM wallet module
        import('./scripts/wallet.js').then(walletModule => {
            window.wallet = walletModule.default;
            console.log('Wallet module loaded successfully on dashboard');
        }).catch(error => {
            console.error('Failed to load wallet module on dashboard:', error);
            // Set wallet to null to indicate failure
            window.wallet = null;
        });
    </script>

    <script src="scripts/main.js"></script>
    <script>
        // Load wallet information when dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if wallet data exists in localStorage
            const walletDataJson = localStorage.getItem('cnetai_wallet');
            if (walletDataJson) {
                try {
                    const walletData = JSON.parse(walletDataJson);
                    // Display the actual wallet address
                    if (walletData.publicKey) {
                        // Generate proper network address from public key
                        // Based on the WASM code, this should be the first 20 bytes of SHA256 hash of public key
                        let displayAddress = walletData.publicKey;
                        
                        // If we have a precomputed address, use that
                        if (walletData.address) {
                            displayAddress = walletData.address;
                        } else if (walletData.publicKey.length > 40) {
                            // For display purposes, shorten long addresses
                            displayAddress = walletData.publicKey.substring(0, 16) + '...' + walletData.publicKey.substring(walletData.publicKey.length - 8);
                        } else if (walletData.publicKey.length > 0) {
                            // For shorter keys, display as is
                            displayAddress = walletData.publicKey;
                        }
                        
                        // Show address with option to copy
                        const publicKeyDisplay = document.getElementById('walletAddress');
                        if (publicKeyDisplay) {
                            publicKeyDisplay.textContent = displayAddress;
                            publicKeyDisplay.title = 'Click to copy';
                            publicKeyDisplay.style.cursor = 'pointer';
                            publicKeyDisplay.addEventListener('click', function() {
                                navigator.clipboard.writeText(walletData.publicKey).then(() => {
                                    const originalText = this.textContent;
                                    this.textContent = 'Copied!';
                                    setTimeout(() => {
                                        this.textContent = originalText;
                                    }, 1000);
                                }).catch(err => {
                                    console.error('Failed to copy:', err);
                                    // Fallback for older browsers
                                    const textArea = document.createElement('textarea');
                                    textArea.value = walletData.publicKey;
                                    document.body.appendChild(textArea);
                                    textArea.select();
                                    try {
                                        document.execCommand('copy');
                                        const originalText = this.textContent;
                                        this.textContent = 'Copied!';
                                        setTimeout(() => {
                                            this.textContent = originalText;
                                        }, 1000);
                                    } catch (err) {
                                        alert('Failed to copy address: ' + walletData.publicKey);
                                    }
                                    document.body.removeChild(textArea);
                                });
                            });
                        }
                    } else {
                        const walletAddressElement = document.getElementById('walletAddress');
                        if (walletAddressElement) {
                            walletAddressElement.textContent = 'Error: No public key';
                        }
                    }
                    
                    // Initialize with 0 balance (in a real implementation you would fetch the actual balance from the network)
                    const tokenBalanceElement = document.getElementById('tokenBalance');
                    if (tokenBalanceElement) {
                        tokenBalanceElement.textContent = '0 ASC';
                    }
                    const battleChipsElement = document.getElementById('battleChips');
                    if (battleChipsElement) {
                        battleChipsElement.textContent = '0';
                    }
                    
                    // Add visual feedback that wallet is loaded
                    const walletInfoCard = document.querySelector('.wallet-info-card');
                    if (walletInfoCard) {
                        walletInfoCard.style.animation = 'glow-pulse 2s infinite';
                    }
                    
                    // Ensure all elements are properly updated
                    setTimeout(() => {
                        const addressElement = document.getElementById('walletAddress');
                        const balanceElement = document.getElementById('tokenBalance');
                        const chipsElement = document.getElementById('battleChips');
                        
                        if (addressElement && addressElement.textContent === 'Loading...') {
                            addressElement.textContent = 'No address available';
                        }
                        
                        if (balanceElement && balanceElement.textContent === 'Loading...') {
                            balanceElement.textContent = '0 ASC';
                        }
                        
                        if (chipsElement && chipsElement.textContent === 'Loading...') {
                            chipsElement.textContent = '0';
                        }
                    }, 1000);
                } catch (e) {
                    console.error('Error parsing wallet data:', e);
                    document.getElementById('walletAddress').textContent = 'Error loading wallet';
                }
            } else {
                document.getElementById('walletAddress').textContent = 'No wallet connected';
                // Redirect to home page if no wallet
                window.location.href = 'index.html';
            }
            
            // Add disconnect functionality
            const disconnectBtn = document.getElementById('disconnectWallet');
            if (disconnectBtn) {
                disconnectBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to disconnect your wallet?')) {
                        localStorage.removeItem('cnetai_wallet');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            // Wallet utility functions
            function hasWallet() {
                // Check if wallet data exists in localStorage
                return localStorage.getItem('cnetai_wallet') !== null;
            }
            
            function getWalletData() {
                try {
                    const walletData = localStorage.getItem('cnetai_wallet');
                    return walletData ? JSON.parse(walletData) : null;
                } catch (e) {
                    console.error('Error parsing wallet data:', e);
                    return null;
                }
            }
            
            function updateWalletUI(publicKey, balance) {
                // Display shortened public key
                const shortKey = publicKey.length > 20 ? 
                    publicKey.substring(0, 6) + '...' + publicKey.substring(publicKey.length - 4) : 
                    publicKey;
                
                // Update wallet info on the current page if elements exist
                const walletAddressElement = document.getElementById('walletAddress');
                const tokenBalanceElement = document.getElementById('tokenBalance');
                const connectWalletBtn = document.getElementById('connectWallet');
                
                if (walletAddressElement) {
                    walletAddressElement.textContent = shortKey;
                }
                if (tokenBalanceElement) {
                    tokenBalanceElement.textContent = balance;
                }
                if (connectWalletBtn) {
                    connectWalletBtn.textContent = 'Connected';
                    connectWalletBtn.disabled = true;
                    connectWalletBtn.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-cyan))';
                    connectWalletBtn.style.boxShadow = '0 0 30px rgba(0, 255, 102, 0.8)';
                }
                
                // Also update header button
                const headerConnectWalletBtn = document.getElementById('connectWallet');
                if (headerConnectWalletBtn) {
                    headerConnectWalletBtn.textContent = 'Connected';
                    headerConnectWalletBtn.disabled = true;
                }
            }
            
            // Add send tokens functionality
            const sendTokensBtn = document.getElementById('sendTokens');
            if (sendTokensBtn) {
                sendTokensBtn.addEventListener('click', function() {
                    // Get the actual wallet address for the send form
                    const walletDataJson = localStorage.getItem('cnetai_wallet');
                    if (walletDataJson) {
                        try {
                            const walletData = JSON.parse(walletDataJson);
                            const sendTo = prompt('Enter recipient address:', '');
                            if (sendTo && sendTo.trim() !== '') {
                                const amount = prompt('Enter amount of ASC to send:', '0');
                                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                                    alert(`Transaction details:
From: ${walletData.publicKey}
To: ${sendTo}
Amount: ${amount} ASC

In a real implementation, this would connect to the CNetAI network.`);
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing wallet data:', e);
                            alert('Error: Could not load wallet data');
                        }
                    } else {
                        alert('No wallet connected');
                    }
                });
            }
            
            // Add event listener for header unlock wallet button
            const headerConnectWalletBtn = document.getElementById('connectWallet');
            if (headerConnectWalletBtn) {
                headerConnectWalletBtn.addEventListener('click', async function() {
                    console.log('[DASHBOARD] Header connect wallet button clicked');
                    
                    // Add visual feedback
                    this.style.animation = 'button-click 0.3s';
                    
                    // Check if wallet module is loaded
                    if (!window.wallet) {
                        console.warn('[DASHBOARD] Wallet module not loaded yet');
                        alert('Wallet functionality is initializing. Please try again in a moment.');
                        return;
                    }
                    
                    console.log('[DASHBOARD] Wallet module is available, proceeding with connection');
                    
                    // Check if wallet file exists
                    if (hasWallet()) {
                        console.log('[DASHBOARD] Existing wallet found, showing unlock form');
                        // Update button text to show we're working
                        this.textContent = 'Unlocking...';
                        
                        // Get modal elements
                        const walletModalElement = document.getElementById('walletModal');
                        const walletSetupContainerElement = document.getElementById('walletSetupContainer');
                        
                        // Safety check for walletSetupContainer
                        if (!walletSetupContainerElement) {
                            console.error('[DASHBOARD] walletSetupContainer not found');
                            alert('Wallet setup container not found. Please refresh the page.');
                            return;
                        }
                        
                        // Additional safety check for wallet module
                        if (!window.wallet) {
                            console.error('[DASHBOARD] Wallet module not loaded');
                            alert('Wallet functionality is not available yet. Please try again in a moment.');
                            return;
                        }
                        
                        walletSetupContainerElement.innerHTML = `
                            <h2>Unlock Your Wallet</h2>
                            <div class="wallet-setup-form">
                                <div class="form-group">
                                    <label for="unlockPassword">Password</label>
                                    <input type="password" id="unlockPassword" placeholder="Enter your wallet password">
                                </div>
                                <div class="actions">
                                    <button class="btn secondary-btn" id="cancelUnlockBtn">Cancel</button>
                                    <button class="btn primary-btn" id="unlockWalletBtn">Unlock</button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listeners with safety checks
                        const cancelUnlockBtn = document.getElementById('cancelUnlockBtn');
                        const unlockWalletBtn = document.getElementById('unlockWalletBtn');
                        
                        if (cancelUnlockBtn) {
                            cancelUnlockBtn.addEventListener('click', function() {
                                if (walletModalElement) {
                                    walletModalElement.style.display = 'none';
                                }
                            });
                        }
                        
                        if (unlockWalletBtn) {
                            unlockWalletBtn.addEventListener('click', async function() {
                                const password = document.getElementById('unlockPassword') ? document.getElementById('unlockPassword').value : '';
                                
                                if (!password) {
                                    alert('Please enter your password');
                                    return;
                                }
                                
                                try {
                                    // Import the existing wallet
                                    const walletDataJson = localStorage.getItem('cnetai_wallet');
                                    if (!walletDataJson) {
                                        alert('No wallet found');
                                        return;
                                    }
                                    
                                    // Parse the wallet data and extract the WASM wallet data
                                    const walletData = JSON.parse(walletDataJson);
                                    
                                    // Additional safety check
                                    if (!walletData.walletData) {
                                        console.error('[DASHBOARD] Wallet data is missing WASM wallet data');
                                        alert('Wallet data is corrupted. Please create a new wallet.');
                                        return;
                                    }
                                    
                                    const success = await window.wallet.importWallet(walletData.walletData, password);
                                    if (success) {
                                        const publicKey = window.wallet.getPublicKey();
                                        updateWalletUI(publicKey, '0 ASC'); // Use 0 ASC instead of fake value
                                        
                                        // Close modal safely
                                        if (walletModalElement) {
                                            walletModalElement.style.display = 'none';
                                        }
                                        
                                        // Update header button
                                        const headerConnectWalletBtn = document.getElementById('connectWallet');
                                        if (headerConnectWalletBtn) {
                                            headerConnectWalletBtn.textContent = 'Connected';
                                            headerConnectWalletBtn.disabled = true;
                                        }
                                        
                                        // Show success message
                                        alert('Wallet unlocked successfully!');
                                    } else {
                                        alert('Failed to unlock wallet. Incorrect password.');
                                    }
                                } catch (error) {
                                    console.error('[DASHBOARD] Error unlocking wallet:', error);
                                    alert('Failed to unlock wallet: ' + error.message);
                                }
                            });
                        }
                        
                        // Show modal with safety check
                        if (walletModalElement) {
                            walletModalElement.style.display = 'block';
                            console.log('[DASHBOARD] Wallet modal displayed');
                        } else {
                            console.error('[DASHBOARD] Wallet modal not found');
                            // Reset button text if modal not found
                            this.textContent = 'Unlock Wallet';
                        }
                    } else {
                        console.log('[DASHBOARD] No existing wallet found');
                        alert('No wallet found. Please create a wallet on the main page.');
                        return;
                    }
                });
            }
            
            // Add close button functionality
            const closeButtons = document.querySelectorAll('.close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                        // Reset header button text
                        const headerConnectWalletBtn = document.getElementById('connectWallet');
                        if (headerConnectWalletBtn && !headerConnectWalletBtn.disabled) {
                            headerConnectWalletBtn.textContent = 'Unlock Wallet';
                        }
                    }
                });
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                const walletModalElement = document.getElementById('walletModal');
                if (walletModalElement && event.target === walletModalElement) {
                    walletModalElement.style.display = 'none';
                    // Reset header button text
                    const headerConnectWalletBtn = document.getElementById('connectWallet');
                    if (headerConnectWalletBtn && !headerConnectWalletBtn.disabled) {
                        headerConnectWalletBtn.textContent = 'Unlock Wallet';
                    }
                }
            });
            
            // Close modal with ESC key
            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const walletModalElement = document.getElementById('walletModal');
                    if (walletModalElement && walletModalElement.style.display === 'block') {
                        walletModalElement.style.display = 'none';
                        // Reset header button text
                        const headerConnectWalletBtn = document.getElementById('connectWallet');
                        if (headerConnectWalletBtn && !headerConnectWalletBtn.disabled) {
                            headerConnectWalletBtn.textContent = 'Unlock Wallet';
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>